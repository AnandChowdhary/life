name: Sync location to Cal.com
on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  sync:
    name: Update Cal.com bio & timezone
    runs-on: ubuntu-latest
    steps:
      - name: Fetch location and update Cal.com
        env:
          CAL_API_KEY: ${{ secrets.CAL_API_KEY }}
        run: |
          set -euo pipefail

          # 1. Fetch current location
          LOCATION=$(curl -sf https://raw.githubusercontent.com/AnandChowdhary/location/main/api.json)
          LABEL=$(echo "$LOCATION" | jq -r '.label')
          EMOJI=$(echo "$LOCATION" | jq -r '.country_emoji')
          TIMEZONE=$(echo "$LOCATION" | jq -r '.timezone.name')

          echo "üìç Location: $LABEL ($EMOJI) ‚Äî TZ: $TIMEZONE"

          # 2. Get current bio from Cal.com (v2 API)
          ME=$(curl -sf -H "Authorization: Bearer ${CAL_API_KEY}" "https://api.cal.com/v2/me")
          CURRENT_BIO=$(echo "$ME" | jq -r '.data.bio // ""')
          echo "Current bio: $CURRENT_BIO"

          # 3. Build new location line
          LOCATION_LINE="${EMOJI} Currently in ${LABEL}"

          # 4. Update bio: replace first line if it starts with "Currently in" pattern, otherwise prepend
          if echo "$CURRENT_BIO" | head -1 | grep -q 'Currently in '; then
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$(echo "$CURRENT_BIO" | tail -n +2)")
          else
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$CURRENT_BIO")
          fi

          echo "New bio: $NEW_BIO"

          # 5. PATCH Cal.com profile (v2 API)
          PAYLOAD=$(jq -n \
            --arg bio "$NEW_BIO" \
            --arg tz "$TIMEZONE" \
            '{bio: $bio, timeZone: $tz}')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CAL_API_KEY}" \
            -d "$PAYLOAD" \
            "https://api.cal.com/v2/me")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Cal.com updated: $LOCATION_LINE | TZ: $TIMEZONE"
          else
            echo "‚ùå Failed with HTTP $HTTP_CODE"
            echo "$BODY"
            exit 1
          fi
