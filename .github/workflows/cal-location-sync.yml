name: Sync location to Cal.com
on:
  schedule:
    - cron: "0 10 * * *"
  repository_dispatch:
    types: [cal-sync]
  workflow_dispatch:

jobs:
  sync:
    name: Update Cal.com bio & timezone
    runs-on: ubuntu-latest
    steps:
      - name: Fetch location and update Cal.com
        env:
          CAL_API_KEY: ${{ secrets.CAL_API_KEY }}
          CAL_USER_ID: ${{ secrets.CAL_USER_ID }}
          EVENT_COFFEE_NL: "1312606"
          EVENT_COFFEE_SF: "1312571"
        run: |
          set -euo pipefail

          # 1. Fetch current location
          LOCATION=$(curl -sf https://raw.githubusercontent.com/AnandChowdhary/location/main/api.json)
          LABEL=$(echo "$LOCATION" | jq -r '.label')
          EMOJI=$(echo "$LOCATION" | jq -r '.country_emoji')
          TIMEZONE=$(echo "$LOCATION" | jq -r '.timezone.name')
          COUNTRY_CODE=$(echo "$LOCATION" | jq -r '.country_code')
          COUNTRY=$(echo "$LOCATION" | jq -r '.full_label' | rev | cut -d',' -f1 | rev | xargs)

          echo "üìç Location: $LABEL, $COUNTRY ($EMOJI) ‚Äî TZ: $TIMEZONE ‚Äî CC: $COUNTRY_CODE"

          # 2. Get current bio from Cal.com (v2 API)
          ME=$(curl -sf -H "Authorization: Bearer ${CAL_API_KEY}" "https://api.cal.com/v2/me")
          CURRENT_BIO=$(echo "$ME" | jq -r '.data.bio // ""')
          echo "Current bio: $CURRENT_BIO"

          # 3. Build new location line (country, not city)
          LOCATION_LINE="${EMOJI} Currently in ${COUNTRY}"

          # 4. Update bio: replace first line if it has "Currently in", otherwise prepend
          if echo "$CURRENT_BIO" | head -1 | grep -q 'Currently in '; then
            REST=$(echo "$CURRENT_BIO" | tail -n +2)
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$REST")
          else
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$CURRENT_BIO")
          fi

          echo "New bio: $NEW_BIO"

          # 5. PATCH Cal.com profile (v2 API)
          PAYLOAD=$(jq -n --arg bio "$NEW_BIO" --arg tz "$TIMEZONE" '{bio: $bio, timeZone: $tz}')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CAL_API_KEY}" \
            -d "$PAYLOAD" \
            "https://api.cal.com/v2/me")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Profile updated: $LOCATION_LINE | TZ: $TIMEZONE"
          else
            echo "‚ùå Profile update failed with HTTP $HTTP_CODE"
            echo "$RESPONSE" | sed '$d'
            exit 1
          fi

          # 6. Update location-specific event types
          echo ""
          echo "Updating event type availability notes..."

          NL_DESC="Meet Anand for an IRL coffee in Amsterdam or Utrecht. _Invite-only and when I am in the Netherlands._"
          SF_DESC="Meet Anand for an IRL coffee at Shack 15 (Ferry Building). _Invite-only and when I am in the Bay Area._"

          if [ "$COUNTRY_CODE" = "nl" ]; then
            NL_NOTE="‚úÖ Anand is currently in the area ‚Äî book a time!"
          else
            NL_NOTE="‚ùå Anand is not currently in this location."
          fi

          if [ "$COUNTRY_CODE" = "us" ]; then
            SF_NOTE="‚úÖ Anand is currently in the area ‚Äî book a time!"
          else
            SF_NOTE="‚ùå Anand is not currently in this location."
          fi

          curl -s -o /dev/null -X PATCH -H "Content-Type: application/json" \
            -d "$(jq -n --arg d "$NL_DESC

          $NL_NOTE" '{description: $d}')" \
            "https://api.cal.com/v1/event-types/${EVENT_COFFEE_NL}?apiKey=${CAL_API_KEY}"
          echo "  ‚Üí Coffee NL: $NL_NOTE"

          curl -s -o /dev/null -X PATCH -H "Content-Type: application/json" \
            -d "$(jq -n --arg d "$SF_DESC

          $SF_NOTE" '{description: $d}')" \
            "https://api.cal.com/v1/event-types/${EVENT_COFFEE_SF}?apiKey=${CAL_API_KEY}"
          echo "  ‚Üí Coffee SF: $SF_NOTE"

          echo ""
          echo "üéâ All done!"
