name: Sync location to Cal.com
on:
  schedule:
    - cron: "0 10 * * *"
  workflow_dispatch:

jobs:
  sync:
    name: Update Cal.com bio & timezone
    runs-on: ubuntu-latest
    steps:
      - name: Fetch location and update Cal.com
        env:
          CAL_API_KEY: ${{ secrets.CAL_API_KEY }}
          CAL_USER_ID: ${{ secrets.CAL_USER_ID }}
          # Location-specific event type IDs
          EVENT_COFFEE_NL: "1312606"
          EVENT_COFFEE_SF: "1312571"
        run: |
          set -euo pipefail

          # 1. Fetch current location
          LOCATION=$(curl -sf https://raw.githubusercontent.com/AnandChowdhary/location/main/api.json)
          LABEL=$(echo "$LOCATION" | jq -r '.label')
          EMOJI=$(echo "$LOCATION" | jq -r '.country_emoji')
          TIMEZONE=$(echo "$LOCATION" | jq -r '.timezone.name')
          COUNTRY_CODE=$(echo "$LOCATION" | jq -r '.country_code')
          # Extract country name from the last part of full_label
          COUNTRY=$(echo "$LOCATION" | jq -r '.full_label' | rev | cut -d',' -f1 | rev | xargs)

          echo "ðŸ“ Location: $LABEL, $COUNTRY ($EMOJI) â€” TZ: $TIMEZONE â€” CC: $COUNTRY_CODE"

          # 2. Get current bio from Cal.com (v2 API)
          ME=$(curl -sf -H "Authorization: Bearer ${CAL_API_KEY}" "https://api.cal.com/v2/me")
          CURRENT_BIO=$(echo "$ME" | jq -r '.data.bio // ""')
          echo "Current bio: $CURRENT_BIO"

          # 3. Build new location line (country, not city)
          LOCATION_LINE="${EMOJI} Currently in ${COUNTRY}"

          # 4. Update bio: replace first line if it starts with "Currently in" pattern, otherwise prepend
          if echo "$CURRENT_BIO" | head -1 | grep -q 'Currently in '; then
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$(echo "$CURRENT_BIO" | tail -n +2)")
          else
            NEW_BIO=$(printf '%s\n%s' "$LOCATION_LINE" "$CURRENT_BIO")
          fi

          echo "New bio: $NEW_BIO"

          # 5. PATCH Cal.com profile (v2 API)
          PAYLOAD=$(jq -n \
            --arg bio "$NEW_BIO" \
            --arg tz "$TIMEZONE" \
            '{bio: $bio, timeZone: $tz}')

          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CAL_API_KEY}" \
            -d "$PAYLOAD" \
            "https://api.cal.com/v2/me")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Profile updated: $LOCATION_LINE | TZ: $TIMEZONE"
          else
            echo "âŒ Profile update failed with HTTP $HTTP_CODE"
            echo "$RESPONSE" | sed '$d'
            exit 1
          fi

          # 6. Update location-specific event types with availability note
          update_event_note() {
            local EVENT_ID=$1
            local BASE_DESC=$2
            local IS_HERE=$3

            if [ "$IS_HERE" = "true" ]; then
              NOTE="âœ… Anand is currently in the area â€” book a time!"
            else
              NOTE="âŒ Anand is not currently in this location."
            fi

            NEW_DESC="${BASE_DESC}

${NOTE}"

            curl -s -X PATCH \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg desc "$NEW_DESC" '{description: $desc}')" \
              "https://api.cal.com/v1/event-types/${EVENT_ID}?apiKey=${CAL_API_KEY}" > /dev/null

            echo "  â†’ Event $EVENT_ID: $NOTE"
          }

          echo ""
          echo "Updating event type availability notes..."

          # Coffee in NL â€” available when country_code is "nl"
          NL_HERE="false"
          [ "$COUNTRY_CODE" = "nl" ] && NL_HERE="true"
          update_event_note "$EVENT_COFFEE_NL" \
            "Meet Anand for an IRL coffee in Amsterdam or Utrecht. _Invite-only and when I am in the Netherlands._" \
            "$NL_HERE"

          # Coffee in SF â€” available when country_code is "us"
          SF_HERE="false"
          [ "$COUNTRY_CODE" = "us" ] && SF_HERE="true"
          update_event_note "$EVENT_COFFEE_SF" \
            "Meet Anand for an IRL coffee at Shack 15 (Ferry Building). _Invite-only and when I am in the Bay Area._" \
            "$SF_HERE"

          echo ""
          echo "ðŸŽ‰ All done!"
